From b142699c7045726fd6564c4e48e34c3932015e86 Mon Sep 17 00:00:00 2001
From: Josua Mayer <josua@solid-run.com>
Date: Wed, 6 Aug 2025 12:31:11 +0200
Subject: [PATCH 20/25] board: solidrun: lx2160cex7: sync with nxp boards

Signed-off-by: Josua Mayer <josua@solid-run.com>
---
 board/solidrun/lx2160acex7/eth_lx2160acex7.c | 36 +++++----
 board/solidrun/lx2160acex7/lx2160a.c         | 80 ++++++--------------
 configs/lx2160acex7_tfa_defconfig            |  1 -
 include/configs/lx2160acex7.h                |  1 +
 4 files changed, 43 insertions(+), 75 deletions(-)

diff --git a/board/solidrun/lx2160acex7/eth_lx2160acex7.c b/board/solidrun/lx2160acex7/eth_lx2160acex7.c
index 3cdb48c2ae2..cb8cd425c68 100644
--- a/board/solidrun/lx2160acex7/eth_lx2160acex7.c
+++ b/board/solidrun/lx2160acex7/eth_lx2160acex7.c
@@ -58,22 +58,7 @@ static void dpmac_set_phymode(void *fdt, unsigned int id, const char *mode) {
 /*
  * Fixup dpmac phy-modes by serdes protocol to fix ethernet driver probe
  */
-void board_fix_fdt_eth(void *fdt) {
-	struct ccsr_gur __iomem *gur = (void *)(CFG_SYS_FSL_GUTS_ADDR);
-	u32 is_lx2162 = get_svr() & 0x800;
-	u32 srds_s1, srds_s2;
-
-	srds_s1 = in_le32(&gur->rcwsr[FSL_CHASSIS3_SRDS1_REGSR - 1]) &
-			  FSL_CHASSIS3_RCWSR28_SRDS1_PRTCL_MASK;
-	srds_s1 >>= FSL_CHASSIS3_RCWSR28_SRDS1_PRTCL_SHIFT;
-
-	srds_s2 = in_le32(&gur->rcwsr[FSL_CHASSIS3_SRDS2_REGSR - 1]) &
-			  FSL_CHASSIS3_RCWSR28_SRDS2_PRTCL_MASK;
-	srds_s2 >>= FSL_CHASSIS3_RCWSR28_SRDS2_PRTCL_SHIFT;
-
-	/* allocate space in case properties must be added */
-	fdt_increase_size(fdt, 256);
-
+static void board_fix_fdt_dpmac_phymode(void *fdt, u32 srds_s1, u32 srds_s2, u32 is_lx2162) {
 	switch (srds_s1) {
 	case 0:
 	case 1:
@@ -351,3 +336,22 @@ void board_fix_fdt_eth(void *fdt) {
 		break;
 	}
 }
+
+void board_fix_fdt_eth(void *fdt) {
+	struct ccsr_gur __iomem *gur = (void *)(CFG_SYS_FSL_GUTS_ADDR);
+	u32 is_lx2162 = get_svr() & 0x800;
+	u32 srds_s1, srds_s2;
+
+	srds_s1 = in_le32(&gur->rcwsr[FSL_CHASSIS3_SRDS1_REGSR - 1]) &
+			  FSL_CHASSIS3_RCWSR28_SRDS1_PRTCL_MASK;
+	srds_s1 >>= FSL_CHASSIS3_RCWSR28_SRDS1_PRTCL_SHIFT;
+
+	srds_s2 = in_le32(&gur->rcwsr[FSL_CHASSIS3_SRDS2_REGSR - 1]) &
+			  FSL_CHASSIS3_RCWSR28_SRDS2_PRTCL_MASK;
+	srds_s2 >>= FSL_CHASSIS3_RCWSR28_SRDS2_PRTCL_SHIFT;
+
+	/* allocate space in case properties must be added */
+	fdt_increase_size(fdt, 256);
+
+	board_fix_fdt_dpmac_phymode(fdt, srds_s1, srds_s2, is_lx2162);
+}
diff --git a/board/solidrun/lx2160acex7/lx2160a.c b/board/solidrun/lx2160acex7/lx2160a.c
index 2f327348e68..1f742b0b0c6 100644
--- a/board/solidrun/lx2160acex7/lx2160a.c
+++ b/board/solidrun/lx2160acex7/lx2160a.c
@@ -23,10 +23,6 @@ DECLARE_GLOBAL_DATA_PTR;
 
 int board_early_init_f(void)
 {
-#ifdef CONFIG_SYS_I2C_EARLY_INIT
-	i2c_early_init_f();
-#endif
-
 	fsl_lsch3_early_init_f();
 	return 0;
 }
@@ -34,6 +30,7 @@ int board_early_init_f(void)
 #ifdef CONFIG_OF_BOARD_FIXUP
 void board_fix_fdt_eth(void *fdt);
 
+/* fdt fixup for u-boot itself */
 int board_fix_fdt(void *fdt)
 {
 	char *reg_names, *reg_name;
@@ -46,26 +43,14 @@ int board_fix_fdt(void *fdt)
 		{ "pf_ctrl", "ctrl" }
 	};
 	int off = -1, i = 0;
-	u32 is_lx2162 = get_svr() & 0x800;
-
-	if (is_lx2162) {
-		/* allocate space for changes */
-		fdt_increase_size(fdt, 32);
-
-		/* LX2162 does not have second USB controller, disable */
-		do_fixup_by_path_string(fdt, "/usb3@3110000", "status", "disabled");
-
-		/* LX2162 SoM has different tlv eeprom - enable and patch alias */
-		do_fixup_by_path_string(fdt, "/aliases", "tlv0", "/i2c@2000000/eeprom@57");
-		do_fixup_by_path_string(fdt, "/i2c@2000000/eeprom@57", "status", "okay");
-		do_fixup_by_path_string(fdt, "/i2c@2000000/i2c-mux@77/i2c@0/eeprom@57", "status", "disabled");
-	}
 
 	board_fix_fdt_eth(fdt);
 
+	/* skip pci fixup on silicon version 1 */
 	if (IS_SVR_REV(get_svr(), 1, 0))
 		return 0;
 
+	/* fixup pci controller for silicon version 2 */
 	off = fdt_node_offset_by_compatible(fdt, -1, "fsl,lx2160a-pcie");
 	while (off != -FDT_ERR_NOTFOUND) {
 		fdt_setprop(fdt, off, "compatible", "fsl,ls-pcie",
@@ -117,39 +102,27 @@ int board_fix_fdt(void *fdt)
 }
 #endif
 
-int esdhc_status_fixup(void *blob, const char *compat)
-{
-	/* Enable both esdhc DT nodes for LX2160ARDB */
-	do_fixup_by_compat(blob, compat, "status", "okay",
-			   sizeof("okay"), 1);
-
-	return 0;
-}
-
 int checkboard(void)
 {
 	enum boot_src src = get_boot_src();
 	char buf[64];
 
 	cpu_name(buf);
-	printf("Board: LX2160A-CEX7, %s, boot from ", buf);
 
+	puts("Boot Source: ");
 	if (src == BOOT_SOURCE_SD_MMC) {
 		puts("SD\n");
 	} else if (src == BOOT_SOURCE_SD_MMC2) {
 		puts("eMMC\n");
 	} else if (src == BOOT_SOURCE_XSPI_NOR) {
 		puts("FlexSPI\n");
+	} else {
+		puts("Unknown\n");
 	}
 
 	return 0;
 }
 
-int config_board_mux(void)
-{
-	return 0;
-}
-
 unsigned long get_board_sys_clk(void)
 {
 	return 100000000;
@@ -162,33 +135,12 @@ unsigned long get_board_ddr_clk(void)
 
 int board_init(void)
 {
-#ifdef CONFIG_ENV_IS_NOWHERE
-	gd->env_addr = (ulong)&default_environment[0];
-#endif
-
-#if !defined(CONFIG_SYS_EARLY_PCI_INIT) && defined(CONFIG_DM_ETH)
-	pci_init();
-#endif
 	return 0;
 }
 
-void detail_board_ddr_info(void)
-{
-	int i;
-	u64 ddr_size = 0;
-
-	puts("\nDDR    ");
-	for (i = 0; i < CONFIG_NR_DRAM_BANKS; i++)
-		ddr_size += gd->bd->bi_dram[i].size;
-	print_size(ddr_size, "");
-	print_ddr_info(0);
-}
-
-#ifdef CONFIG_MISC_INIT_R
-int misc_init_r(void)
-{
-	config_board_mux();
-
+#ifdef CONFIG_BOARD_LATE_INIT
+int fsl_board_late_init(void) {
+	/* TODO: configure fan-controller here and release gpio-hog */
 	return 0;
 }
 #endif
@@ -198,9 +150,11 @@ void fdt_fixup_board_enet(void *fdt)
 {
 	int offset;
 
+	/* mainline linux has fsl-mc below soc node */
 	offset = fdt_path_offset(fdt, "/soc/fsl-mc");
 
 	if (offset < 0)
+		/* older versions had fsl-mc at root level */
 		offset = fdt_path_offset(fdt, "/fsl-mc");
 
 	if (offset < 0) {
@@ -213,6 +167,7 @@ void fdt_fixup_board_enet(void *fdt)
 	    (is_lazy_dpl_addr_valid() || get_dpl_apply_status() == 0)) {
 		fdt_status_okay(fdt, offset);
 	} else {
+		/* mc startup failed, disable in dtb */
 		fdt_status_fail(fdt, offset);
 	}
 }
@@ -234,6 +189,14 @@ int ft_board_setup(void *blob, struct bd_info *bd)
 	u64 mc_memory_base = 0;
 	u64 mc_memory_size = 0;
 	u16 total_memory_banks;
+	int err;
+
+	err = fdt_increase_size(blob, 512);
+	if (err) {
+		printf("%s fdt_increase_size: err=%s\n", __func__,
+		       fdt_strerror(err));
+		return err;
+	}
 
 	ft_cpu_setup(blob, bd);
 
@@ -278,13 +241,14 @@ int ft_board_setup(void *blob, struct bd_info *bd)
 
 	fdt_fixup_memory_banks(blob, base, size, total_memory_banks);
 
-#ifdef CONFIG_USB
+#ifdef CONFIG_USB_HOST
 	fsl_fdt_fixup_dr_usb(blob, bd);
 #endif
 
 #ifdef CONFIG_FSL_MC_ENET
 	fdt_fsl_mc_fixup_iommu_map_entry(blob);
 	fdt_fixup_board_enet(blob);
+	fdt_reserve_mc_mem(blob, 0x4000);
 #endif
 	fdt_fixup_icid(blob);
 
diff --git a/configs/lx2160acex7_tfa_defconfig b/configs/lx2160acex7_tfa_defconfig
index 95038b4bb28..50f926b0ad4 100644
--- a/configs/lx2160acex7_tfa_defconfig
+++ b/configs/lx2160acex7_tfa_defconfig
@@ -32,7 +32,6 @@ CONFIG_USE_BOOTARGS=y
 CONFIG_BOOTARGS="console=ttyAMA0,115200 root=/dev/ram0 earlycon=pl011,mmio32,0x21c0000 ramdisk_size=0x2000000 default_hugepagesz=1024m hugepagesz=1024m hugepages=2 pci=pcie_bus_perf"
 CONFIG_DEFAULT_FDT_FILE="freescale/fsl-lx2160a-clearfog-cx.dtb"
 CONFIG_SYS_PBSIZE=532
-CONFIG_MISC_INIT_R=y
 CONFIG_CMD_TLV_EEPROM=y
 CONFIG_CMD_GREPENV=y
 CONFIG_CMD_EEPROM=y
diff --git a/include/configs/lx2160acex7.h b/include/configs/lx2160acex7.h
index e99b41adafc..652cce98b66 100644
--- a/include/configs/lx2160acex7.h
+++ b/include/configs/lx2160acex7.h
@@ -241,6 +241,7 @@
 	func(USB, usb, 0) \
 	func(MMC, mmc, 0) \
 	func(MMC, mmc, 1) \
+	func(NVME, nvme, 0) \
 	func(SCSI, scsi, 0) \
 	func(SCSI, scsi, 1) \
 	func(SCSI, scsi, 2) \
-- 
2.43.0

