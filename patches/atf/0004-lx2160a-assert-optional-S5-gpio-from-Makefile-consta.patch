From 36bf5eae8356d2c89047e8b5f751d6f2c2d922a1 Mon Sep 17 00:00:00 2001
From: Rabeeh Khoury <rabeeh@solid-run.com>
Date: Sun, 28 Nov 2021 13:33:10 +0200
Subject: [PATCH 04/15] lx2160a: assert optional S5 gpio from Makefile constant

GPIO address and number for S5 are specific per board and should not be
set globally across lx2160.

Add support for setting gpio address and number form platform.mk, into
soc.mk:

- LX2160A_S5_GPIO_ADDR: gpio value register address
- LX2160A_S5_GPIO: gpio number

This feature can be enabled for individual boards by setting a non-zero
address in platform.mk file, before including soc.mk.

Signed-off-by: Josua Mayer <josua@solid-run.com>
---
 plat/nxp/soc-lx2160a/aarch64/lx2160a.S | 8 ++++++++
 plat/nxp/soc-lx2160a/soc.mk            | 8 ++++++++
 2 files changed, 16 insertions(+)

diff --git a/plat/nxp/soc-lx2160a/aarch64/lx2160a.S b/plat/nxp/soc-lx2160a/aarch64/lx2160a.S
index cc679f2ba..67ade7b66 100644
--- a/plat/nxp/soc-lx2160a/aarch64/lx2160a.S
+++ b/plat/nxp/soc-lx2160a/aarch64/lx2160a.S
@@ -563,6 +563,14 @@ endfunc _soc_sys_reset
  */
 func _soc_sys_off
 
+#if defined(CONFIG_LX2160A_S5_GPIO_ADDR) && defined(CONFIG_LX2160A_S5_GPIO)
+	/* assert s5 gpio */
+	mov x3, # CONFIG_LX2160A_S5_GPIO_ADDR
+	ldr w1, [x3]
+	orr w1, w1, # 1 << (31 - CONFIG_LX2160A_S5_GPIO)
+	str w1, [x3]
+#endif
+
 	/* disable sec, QBman, spi and qspi */
 	ldr  x2, =NXP_DCFG_ADDR
 	ldr  x0, =DCFG_DEVDISR1_OFFSET
diff --git a/plat/nxp/soc-lx2160a/soc.mk b/plat/nxp/soc-lx2160a/soc.mk
index a72b4113d..20e64753c 100644
--- a/plat/nxp/soc-lx2160a/soc.mk
+++ b/plat/nxp/soc-lx2160a/soc.mk
@@ -177,3 +177,11 @@ include ${PLAT_PATH}/common/setup/common.mk
 
  # Adding source files to generate separate DDR FIP image
 include ${PLAT_SOC_PATH}/ddr_fip.mk
+
+# S5 GPIO (optional)
+LX2160A_S5_GPIO_ADDR ?= 0
+LX2160A_S5_GPIO ?= 0
+ifneq (${LX2160A_S5_GPIO_ADDR},0)
+$(eval $(call add_define_val,CONFIG_LX2160A_S5_GPIO_ADDR,$(LX2160A_S5_GPIO_ADDR)))
+$(eval $(call add_define_val,CONFIG_LX2160A_S5_GPIO,$(LX2160A_S5_GPIO)))
+endif
-- 
2.43.0

