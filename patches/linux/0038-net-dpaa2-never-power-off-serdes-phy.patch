From 2eb55fcaee9b8f455825a66fe7b932d001343dfa Mon Sep 17 00:00:00 2001
From: Josua Mayer <josua@solid-run.com>
Date: Sat, 13 May 2023 17:50:48 +0300
Subject: [PATCH] net: dpaa2: never power-off serdes phy

When network interfaces are bound to DPDK rather than the Linux kernel,
it has been observed that the serdes phy is powered off, and never
powered on again.

As a workaround replace all occurencs of phy_power_off with phy_power_on,
and re-add prepare and finish callbacks to power on serdes.

Signed-off-by: Josua Mayer <josua@solid-run.com>
---
 .../net/ethernet/freescale/dpaa2/dpaa2-mac.c  | 28 ++++++++++++++++++-
 1 file changed, 27 insertions(+), 1 deletion(-)

diff --git a/drivers/net/ethernet/freescale/dpaa2/dpaa2-mac.c b/drivers/net/ethernet/freescale/dpaa2/dpaa2-mac.c
index 3d4c0f9206fb..26b56318b7cc 100644
--- a/drivers/net/ethernet/freescale/dpaa2/dpaa2-mac.c
+++ b/drivers/net/ethernet/freescale/dpaa2/dpaa2-mac.c
@@ -253,12 +253,38 @@ static void dpaa2_mac_link_down(struct phylink_config *config,
 		netdev_err(mac->net_dev, "dpmac_set_link_state() = %d\n", err);
 }
 
+static int dpaa2_mac_prepare(struct phylink_config *config, unsigned int mode,
+			     phy_interface_t interface)
+{
+	struct dpaa2_mac *mac = phylink_to_dpaa2_mac(config);
+
+	dpaa2_mac_link_down(config, mode, interface);
+
+	if (mac->serdes_phy)
+		phy_power_on(mac->serdes_phy);
+
+	return 0;
+}
+
+static int dpaa2_mac_finish(struct phylink_config *config, unsigned int mode,
+			    phy_interface_t interface)
+{
+	struct dpaa2_mac *mac = phylink_to_dpaa2_mac(config);
+
+	if (mac->serdes_phy)
+		phy_power_on(mac->serdes_phy);
+
+	return 0;
+}
+
 static const struct phylink_mac_ops dpaa2_mac_phylink_ops = {
 	.validate = phylink_generic_validate,
 	.mac_select_pcs = dpaa2_mac_select_pcs,
 	.mac_config = dpaa2_mac_config,
 	.mac_link_up = dpaa2_mac_link_up,
 	.mac_link_down = dpaa2_mac_link_down,
+	.mac_prepare = dpaa2_mac_prepare,
+	.mac_finish = dpaa2_mac_finish,
 };
 
 static int dpaa2_pcs_create(struct dpaa2_mac *mac,
@@ -373,7 +399,7 @@ void dpaa2_mac_stop(struct dpaa2_mac *mac)
 	int i;
 
 	if (mac->serdes_phy)
-		phy_power_off(mac->serdes_phy);
+		phy_power_on(mac->serdes_phy);
 
 	for (i = 0; i < sizeof(mac->retimer_phys)/sizeof(mac->retimer_phys[0]); i++) {
 		if (!mac->retimer_phys[i])
-- 
2.43.0

